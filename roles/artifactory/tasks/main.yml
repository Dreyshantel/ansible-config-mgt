---
# ===============================================
# JFrog Artifactory OSS Installation Playbook
# Corrected for tarball installation with PostgreSQL
# ===============================================

# -------------------------------
# 0. Cleanup old Artifactory
# -------------------------------
- name: Stop old Artifactory service if exists
  systemd:
    name: artifactory
    state: stopped
    enabled: no
  ignore_errors: yes
  become: yes

- name: Remove old Artifactory directory
  file:
    path: /opt/jfrog/artifactory
    state: absent
  become: yes

- name: Remove old systemd service
  file:
    path: /etc/systemd/system/artifactory.service
    state: absent
  ignore_errors: yes
  become: yes

- name: Reload systemd
  systemd:
    daemon_reload: yes
  become: yes

# -------------------------------
# 1. Install dependencies: Java & PostgreSQL
# -------------------------------
- name: Install required packages
  apt:
    name:
      - openjdk-17-jdk
      - postgresql
      - postgresql-contrib
      - wget
      - curl
      - unzip
      - gnupg
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes
  become: yes

# -------------------------------
# 2. Create PostgreSQL DB and user
# -------------------------------
- name: Ensure PostgreSQL user 'artifactory' exists
  become_user: postgres
  postgresql_user:
    name: artifactory
    password: "Art1Factory@123"
    state: present

- name: Ensure PostgreSQL database 'artifactory' exists
  become_user: postgres
  postgresql_db:
    name: artifactory
    owner: artifactory
    state: present

# -------------------------------
# 3. Download and install Artifactory tarball
# -------------------------------
- name: Download JFrog Artifactory OSS tarball
  get_url:
    url: https://releases.jfrog.io/artifactory/artifactory-oss/org/artifactory/oss/jfrog-artifactory-oss-7.125.6-linux.tar.gz
    dest: /tmp/artifactory.tar.gz
    mode: '0644'
    force: yes
  become: yes

- name: Extract Artifactory tarball
  unarchive:
    src: /tmp/artifactory.tar.gz
    dest: /opt/jfrog
    remote_src: yes
  become: yes

- name: Rename extracted folder to /opt/jfrog/artifactory
  command: mv /opt/jfrog/artifactory-oss-7.125.6 /opt/jfrog/artifactory
  args:
    removes: /opt/jfrog/artifactory-oss-7.125.6
  become: yes

- name: Create artifactory system user
  user:
    name: artifactory
    system: yes
    shell: /bin/false
  become: yes

- name: Set ownership for Artifactory directory
  file:
    path: /opt/jfrog/artifactory
    state: directory
    recurse: yes
    owner: artifactory
    group: artifactory
  become: yes

# -------------------------------
# 4. Create system.yaml with PostgreSQL config
# -------------------------------
- name: Create system.yaml
  copy:
    dest: /opt/jfrog/artifactory/var/etc/system.yaml
    content: |
      configVersion: 1
      shared:
        security:
        node:
        database:
          type: postgresql
          driver: org.postgresql.Driver
          url: "jdbc:postgresql://localhost:5432/artifactory"
          username: artifactory
          password: "Art1Factory@123"
      access:
        port: 8046
        bind:
          address: 0.0.0.0
    owner: artifactory
    group: artifactory
    mode: '0644'
  become: yes

# -------------------------------
# 5. Configure systemd service
# -------------------------------
- name: Create Artifactory systemd service
  copy:
    dest: /etc/systemd/system/artifactory.service
    content: |
      [Unit]
      Description=Artifactory service
      After=network.target

      [Service]
      SuccessExitStatus=143
      Type=forking
      GuessMainPID=yes
      Restart=always
      RestartSec=60
      PIDFile=/var/run/artifactory.pid
      ExecStart=/opt/jfrog/artifactory/app/bin/artifactoryManage.sh start
      ExecStop=/opt/jfrog/artifactory/app/bin/artifactoryManage.sh stop
      User=artifactory
      Group=artifactory
      Environment=JFROG_HOME=/opt/jfrog
      Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

      [Install]
      WantedBy=multi-user.target
  become: yes

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

# -------------------------------
# 6. Start Artifactory service
# -------------------------------
- name: Enable Artifactory service
  systemd:
    name: artifactory
    enabled: yes
  become: yes

- name: Start Artifactory service
  systemd:
    name: artifactory
    state: started
  become: yes

# -------------------------------
# 7. Wait for Artifactory to be available
# -------------------------------
- name: Wait for Artifactory to listen on port 8046
  wait_for:
    port: 8046
    host: 0.0.0.0
    timeout: 1200
    delay: 10
    msg: "Artifactory did not start on port 8046 within 20 minutes"
  become: yes

- name: Display completion message
  debug:
    msg:
      - "=========================================="
      - "JFrog Artifactory OSS installation complete!"
      - "Access Artifactory at: http://{{ ansible_default_ipv4.address }}:8046"
      - "Default credentials: Username: admin | Password: password"
      - "=========================================="

