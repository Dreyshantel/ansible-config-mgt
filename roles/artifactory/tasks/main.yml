---
# ===============================================
# JFrog Artifactory Installation Playbook
# ===============================================
# Installs JFrog Artifactory OSS on Ubuntu 22.04
# Handles GPG keys robustly and waits for full startup
# ===============================================

- hosts: all
  become: yes
  vars:
    jfrog_repo_url: "https://releases.jfrog.io/artifactory/artifactory-debs"
    jfrog_repo_distro: "xenial"
    jfrog_key_file: "/usr/share/keyrings/jfrog-archive-keyring.gpg"
    artifactory_ports:
      - 8081
      - 8082

  tasks:

    # -------------------------------
    # 0. Cleanup old JFrog repo files
    # -------------------------------
    - name: Remove old JFrog repository files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/artifactory.list
        - /etc/apt/sources.list.d/jfrog.list

    # -------------------------------
    # 1. Install essential packages for APT and HTTPS
    # -------------------------------
    - name: Install essential packages for APT and HTTPS
      apt:
        name:
          - curl
          - gnupg
          - apt-transport-https
          - ca-certificates
        state: present
        update_cache: yes

    # -------------------------------
    # 2. System update & Java installation
    # -------------------------------
    - name: Update and upgrade Ubuntu
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install Java JDK
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Check Java version
      command: java -version
      register: java_version
      ignore_errors: yes
      changed_when: false

    - debug:
        var: java_version.stderr_lines

    # -------------------------------
    # 3. Add JFrog GPG key and repository
    # -------------------------------
    - name: Remove any existing GPG key file
      file:
        path: "{{ jfrog_key_file }}"
        state: absent

    - name: Download JFrog GPG key to temporary location
      get_url:
        url: "https://releases.jfrog.io/artifactory/api/gpg/key/public"
        dest: /tmp/jfrog-key.asc
        mode: '0644'
        force: yes

    - name: Convert and import JFrog GPG key to binary format
      shell: |
        cat /tmp/jfrog-key.asc | gpg --dearmor > "{{ jfrog_key_file }}"
        chmod 644 "{{ jfrog_key_file }}"

    - name: Add JFrog repository
      copy:
        content: "deb [signed-by={{ jfrog_key_file }}] {{ jfrog_repo_url }} {{ jfrog_repo_distro }} main"
        dest: /etc/apt/sources.list.d/jfrog.list
        mode: '0644'

    - name: Remove temporary key file
      file:
        path: /tmp/jfrog-key.asc
        state: absent

    - name: Update repository cache
      apt:
        update_cache: yes

    # -------------------------------
    # 4. Install Artifactory
    # -------------------------------
    - name: Install JFrog Artifactory OSS
      apt:
        name: jfrog-artifactory-oss
        state: present
        update_cache: yes
      register: artifactory_install

    - debug:
        msg: "Artifactory installed successfully"
      when: artifactory_install is succeeded

    - name: Enable Artifactory service
      systemd:
        name: artifactory.service
        enabled: yes

    # -------------------------------
    # 5. Start Artifactory and wait for initialization
    # -------------------------------
    - name: Start JFrog Artifactory service (async to avoid timeout)
      systemd:
        name: artifactory.service
        state: started
        daemon_reload: yes
      async: 1800   # 30 minutes
      poll: 0
      register: artifactory_start

    - name: Wait for Artifactory async start to complete
      async_status:
        jid: "{{ artifactory_start.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 180
      delay: 10
      ignore_errors: yes

    - name: Pause for additional initialization
      pause:
        seconds: 300
        prompt: "Waiting 5 minutes for Artifactory to fully initialize"

    # -------------------------------
    # 6. Verify Artifactory service
    # -------------------------------
    - name: Verify Artifactory service status
      command: systemctl status artifactory.service
      register: artifactory_status
      ignore_errors: yes
      changed_when: false

    - debug:
        var: artifactory_status.stdout_lines

    - name: Ensure system.yaml exists
      file:
        path: /opt/jfrog/artifactory/var/etc/system.yaml
        state: touch
        mode: '0644'

    - name: Wait for Artifactory ports to be open
      wait_for:
        port: "{{ item }}"
        host: 0.0.0.0
        timeout: 1800
        delay: 10
        msg: "Artifactory did not start on port {{ item }} within timeout"
      loop: "{{ artifactory_ports }}"
      ignore_errors: yes
      register: port_check

    - name: Display completion message
      debug:
        msg:
          - "=========================================="
          - "JFrog Artifactory Installation Complete!"
          - "Access Artifactory at one of these URLs:"
          - "  http://{{ ansible_default_ipv4.address }}:8081"
          - "  http://{{ ansible_default_ipv4.address }}:8082"
          - "Default credentials: admin / password"
          - "Note: First startup may take 5â€“15 minutes"
          - "=========================================="

    - name: Warn if ports not accessible
      debug:
        msg:
          - "WARNING: Artifactory ports may not be accessible yet"
          - "Check service status and logs manually"
      when: port_check is failed

