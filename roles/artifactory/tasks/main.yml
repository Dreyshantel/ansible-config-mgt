---
# tasks file for Artifactory role

# -------------------------------
# 1. Add JFrog repository and GPG key
# -------------------------------
- name: Download JFrog GPG key
  get_url:
    url: https://releases.jfrog.io/artifactory/api/gpg/key/public
    dest: /usr/share/keyrings/jfrog-archive-keyring.gpg
    mode: '0644'

- name: Add JFrog repository
  copy:
    content: "deb [signed-by=/usr/share/keyrings/jfrog-archive-keyring.gpg] https://releases.jfrog.io/artifactory/artifactory-debs xenial main"
    dest: /etc/apt/sources.list.d/jfrog.list
    mode: '0644'

- name: Update apt cache
  apt:
    update_cache: yes

# -------------------------------
# 2. Install JFrog Artifactory OSS
# -------------------------------
- name: Install Artifactory OSS
  apt:
    name: jfrog-artifactory-oss
    state: present

- name: Enable Artifactory service
  systemd:
    name: artifactory
    enabled: yes
    state: started

- name: Verify Artifactory service status
  systemd:
    name: artifactory
    state: started
    enabled: yes
    register: artifactory_status
    failed_when: artifactory_status.status.ActiveState != "active"

# -------------------------------
# 3. Ensure system.yaml exists
# -------------------------------
- name: Ensure system.yaml exists
  file:
    path: /opt/jfrog/artifactory/var/etc/system.yaml
    state: touch
    mode: '0644'

# -------------------------------
# 4. Update allowNoPostgres setting in system.yaml
# -------------------------------
- name: Enable allowNoPostgres in system.yaml
  lineinfile:
    path: /opt/jfrog/artifactory/var/etc/system.yaml
    regexp: '^ *allowNoPostgres:'
    line: 'allowNoPostgres: true'
    create: yes

# -------------------------------
# 5. Restart Artifactory service to apply changes
# -------------------------------
- name: Restart Artifactory service
  systemd:
    name: artifactory
    state: restarted
    daemon_reload: yes

- name: Wait for Artifactory to be ready
  wait_for:
    port: 8081
    host: 0.0.0.0
    timeout: 600
    delay: 10

- name: Display completion message
  debug:
    msg: |
      ===================================================
      JFrog Artifactory setup complete!
      URL: http://{{ ansible_default_ipv4.address }}:8081
      ===================================================

