---
# Playbook: Install and Configure JFrog Artifactory OSS
- name: Install and configure JFrog Artifactory
  hosts: localhost
  become: yes
  vars:
    artifactory_home: /opt/jfrog/artifactory
    artifactory_version: jfrog-artifactory-oss
    artifactory_port: 8081
    allow_no_postgresql: true   # set to true to avoid PostgreSQL

  tasks:

  # -------------------------------
  # 1. Install required packages for HTTPS repositories
  # -------------------------------
  - name: Install required packages
    apt:
      name:
        - apt-transport-https
        - ca-certificates
        - gnupg
        - curl
      state: present
      update_cache: yes

  # -------------------------------
  # 2. Add JFrog repository and GPG key
  # -------------------------------
  - name: Download JFrog GPG key
    get_url:
      url: https://releases.jfrog.io/artifactory/api/gpg/key/public
      dest: /usr/share/keyrings/jfrog-archive-keyring.gpg
      mode: '0644'

  - name: Add JFrog repository
    copy:
      content: "deb [signed-by=/usr/share/keyrings/jfrog-archive-keyring.gpg] https://releases.jfrog.io/artifactory/artifactory-debs focal main"
      dest: /etc/apt/sources.list.d/jfrog.list
      mode: '0644'

  - name: Update apt cache
    apt:
      update_cache: yes
      cache_valid_time: 3600

  # -------------------------------
  # 3. Install Artifactory OSS
  # -------------------------------
  - name: Install Artifactory OSS
    apt:
      name: "{{ artifactory_version }}"
      state: present

  # -------------------------------
  # 4. Enable and start Artifactory service
  # -------------------------------
  - name: Enable Artifactory service
    systemd:
      name: artifactory
      enabled: yes

  - name: Start Artifactory service
    systemd:
      name: artifactory
      state: started
      daemon_reload: yes

  - name: Wait for Artifactory to be ready
    wait_for:
      port: "{{ artifactory_port }}"
      host: 0.0.0.0
      timeout: 600
      delay: 10

  - name: Verify Artifactory service status
    command: systemctl status artifactory
    register: artifactory_status
    ignore_errors: yes

  - name: Show Artifactory service status
    debug:
      var: artifactory_status.stdout_lines

  # -------------------------------
  # 5. Ensure system.yaml exists
  # -------------------------------
  - name: Ensure system.yaml exists
    file:
      path: "{{ artifactory_home }}/var/etc/system.yaml"
      state: touch
      mode: '0644'

  # -------------------------------
  # 6. Update system.yaml to allow no PostgreSQL
  # -------------------------------
  - name: Update system.yaml to allow no PostgreSQL
    copy:
      dest: "{{ artifactory_home }}/var/etc/system.yaml"
      content: |
        shared:
          database:
            allowNoPostgresql: {{ allow_no_postgresql }}

  # -------------------------------
  # 7. Restart Artifactory to apply changes
  # -------------------------------
  - name: Restart Artifactory service
    systemd:
      name: artifactory
      state: restarted

  - name: Confirm Artifactory service is active
    systemd:
      name: artifactory
      state: started
      enabled: yes

  - name: Display completion message
    debug:
      msg: |
        ===================================================
        JFrog Artifactory Installation Complete!
        URL: http://{{ ansible_default_ipv4.address }}:{{ artifactory_port }}
        ===================================================

