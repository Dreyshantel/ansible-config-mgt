---
# -------------------------------
# 0. Cleanup old JFrog repo files
# -------------------------------
- name: Remove old JFrog repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/artifactory.list
    - /etc/apt/sources.list.d/jfrog.list
  become: yes

# -------------------------------
# 1. Install essential packages for APT and HTTPS
# -------------------------------
- name: Install essential packages for APT and HTTPS
  apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes
  become: yes

# -------------------------------
# 2. System update & Java installation
# -------------------------------
- name: Update and upgrade Ubuntu
  apt:
    update_cache: yes
    upgrade: dist
  become: yes

- name: Install Java JDK
  apt:
    name: openjdk-17-jdk
    state: present
  become: yes

- name: Check Java version
  command: java -version
  register: java_version
  ignore_errors: yes

- debug:
    var: java_version.stderr_lines

# -------------------------------
# 3. Add JFrog GPG key and repository
# -------------------------------
- name: Download JFrog GPG key (non-interactive)
  ansible.builtin.get_url:
    url: https://releases.jfrog.io/artifactory/api/gpg/key/public
    dest: /usr/share/keyrings/jfrog-archive-keyring.gpg
    mode: '0644'
  become: yes

- name: Add JFrog repository (Xenial, works on 22.04)
  ansible.builtin.copy:
    content: "deb [signed-by=/usr/share/keyrings/jfrog-archive-keyring.gpg] https://releases.jfrog.io/artifactory/artifactory-debs xenial main"
    dest: /etc/apt/sources.list.d/jfrog.list
  become: yes

- name: Update the repository cache after adding Artifactory repository
  ansible.builtin.apt:
    update_cache: yes
  become: yes

# -------------------------------
# 4. Install Artifactory
# -------------------------------
- name: Install JFrog Artifactory OSS
  apt:
    name: jfrog-artifactory-oss
    state: present
  become: yes

- name: Start and enable JFrog Artifactory service
  systemd:
    name: artifactory.service
    state: started
    enabled: yes
  become: yes

- name: Verify the status of JFrog Artifactory
  command: systemctl status artifactory.service
  register: artifactory_status
  ignore_errors: yes
  become: yes

- debug:
    var: artifactory_status.stdout_lines

# -------------------------------
# 5. Ensure system.yaml exists
# -------------------------------
- name: Ensure the system.yaml file exists
  file:
    path: /opt/jfrog/artifactory/var/etc/system.yaml
    state: touch
  become: yes

