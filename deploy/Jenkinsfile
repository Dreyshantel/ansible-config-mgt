pipeline {
    agent any

    environment {
        COMPOSER_ALLOW_SUPERUSER = '1'
    }

    stages {

        stage("Initial cleanup") {
            steps {
                deleteDir()
            }
        }

        stage('Checkout PHP Project') {
            steps {
                git branch: 'main', url: 'https://github.com/StegTechHub/php-todo.git'
            }
        }

        stage('Prepare Dependencies') {
            steps {
                sh '''
                    mv .env.sample .env || true
                    composer install --no-interaction --prefer-dist
                    php artisan key:generate
                    php artisan migrate --force
                    php artisan db:seed --force
                '''
            }
        }

        stage('Execute Unit Tests') {
            steps {
                sh './vendor/bin/phpunit --colors=always'
            }
        }

    }

    post {
        always {
            cleanWs(deleteDirs: true)
        }
    }
}

